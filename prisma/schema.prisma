// ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö PostgreSQL
datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

enum Role {
  USER
  ADMIN
}

enum DocumentStatus {
  PENDING
  SENT
  RECEIVED
  READ
  DONE
  ARCHIVED
}

model User {
  id          Int      @id @default(autoincrement())
  firstName   String
  lastName    String
  email       String   @unique
  phoneNumber String
  password    String
  role        Role     @default(USER)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  documents    Document[]
  sentDocs     Sent[]     @relation("Sender")
  receivedDocs Sent[]     @relation("Receiver")

  // ‡∏ù‡∏±‡πà‡∏á‡∏ï‡∏£‡∏á‡∏Ç‡πâ‡∏≤‡∏°‡∏Ç‡∏≠‡∏á Sent.statusBy
  statusChanges Sent[] @relation("StatusBy")

  // üëá ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ù‡∏±‡πà‡∏á‡∏ï‡∏£‡∏á‡∏Ç‡πâ‡∏≤‡∏°‡∏Ç‡∏≠‡∏á SentStatusHistory.changedBy
  statusHistories SentStatusHistory[] @relation("UserStatusHistory")
}

model Document {
  id         Int      @id @default(autoincrement())
  name       String
  fileType   String
  fileUrl    String
  uploadedAt DateTime @default(now())

  userId Int
  user   User   @relation(fields: [userId], references: [id])
  sent   Sent[] @relation("DocumentSent")
}

model Sent {
  id         Int @id @default(autoincrement())
  documentId Int
  senderId   Int
  receiverId Int

  number      String?
  category    String?
  description String?
  status      DocumentStatus @default(PENDING)

  isForwarded  Boolean @default(false)
  parentSentId Int?
  parentSent   Sent?   @relation("Forward", fields: [parentSentId], references: [id])
  forwarded    Sent[]  @relation("Forward")

  threadId Int?
  depth    Int  @default(0)

  sentAt          DateTime  @default(now())
  receivedAt      DateTime?
  readAt          DateTime?
  archivedAt      DateTime?
  statusChangedAt DateTime?

  statusById Int?
  statusBy   User? @relation("StatusBy", fields: [statusById], references: [id])

  document Document @relation("DocumentSent", fields: [documentId], references: [id])
  sender   User     @relation("Sender", fields: [senderId], references: [id])
  receiver User     @relation("Receiver", fields: [receiverId], references: [id])

  statusHistory SentStatusHistory[]

  @@index([parentSentId])
  @@index([threadId, depth])
  @@index([status])
}

model SentStatusHistory {
  id          Int            @id @default(autoincrement())
  sentId      Int
  from        DocumentStatus
  to          DocumentStatus
  changedById Int
  changedAt   DateTime       @default(now())
  note        String?

  sent Sent @relation(fields: [sentId], references: [id], onDelete: Cascade)

  // üëá ‡∏ï‡∏±‡πâ‡∏á‡∏ä‡∏∑‡πà‡∏≠ relation ‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏ô User
  changedBy User @relation("UserStatusHistory", fields: [changedById], references: [id])
}
